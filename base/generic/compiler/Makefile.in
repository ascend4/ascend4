#  ASCEND Compiler Makefile
#  Tom Epperly
#  modified Kirk Abbott to accept the interface.
#  $Date: 2000/01/25 02:25:50 $
#  $Revision: 1.46 $
#  $Author: ballan $
#  $Source: /afs/cs.cmu.edu/project/ascend/Repository/ascend4/compiler/Makefile.in,v $
#


SHELL = /bin/sh
builddir = ..
srcdir = @fullpathsrcdir@/../generic/compiler
VPATH := @fullpathsrcdir@/../generic/compiler



#  The next variables are the primary executables and/or libraries that
#  this makefile is responsible for, and the default target of this
#  makefile.

EXECUTABLE = ascend

PURIFIED_EXEC = ascendp

QUANTIFIED_EXEC = ascendq

LIBRARY = libasc.a


default: $(LIBRARY)



#  Defines and Includes that are specific to this directory

DIR_SPECIFIC_DEFS = 
DIR_SPECIFIC_INCS = 



#  The next variables list the source files (EXEC_SCRS) to compile
#  into the object files (EXEC_OBJS) that are linked with the
#  library files (EXEC_LIBS) to make EXECUTABLE

EXEC_SRCS = actype.c interface.c license.c main.c termsetup.c

EXEC_OBJS = actype.o interface.o license.o main.o termsetup.o \
		$(ARCHIVE)/libasc.a $(ARCHIVE)/libutils.a \
		$(ARCHIVE)/libgeneral.a

EXEC_LIBS = $(DEBUG_MALLOC_LIBS) $(MATH_LIBS) -ltermcap $(DEBUG_LIBS)



#  The next variables list the source files (LIB_SCRS) to compile
#  into the object files (LIB_OBJS) that are combined to make LIBRARY

LIB_SRCS = \
	anoncopy.c anonmerg.c anontype.c arrayinst.c ascCompiler.c \
	ascParse.c atomsize.c atomvalue.c bintoken.c bit.c braced.c \
	case.c check.c child.c childdef.c childio.c childinfo.c cmpfunc.c \
	commands.c copyinst.c createinst.c destroyinst.c \
	dimen.c dimen_io.c dump.c \
	evaluate.c exprio.c exprs.c exprsym.c extcall.c \
	extfunc.c extinst.c find.c forvars.c fractions.c \
	freestore.c func.c initialize.c instance.c instance_io.c \
	instantiate.c instmacro.c instquery.c interval.c \
	library.c linkinst.c logrel_io.c logrel_util.c \
	logrelation.c mathinst.c mergeinst.c module.c name.c \
	nameio.c notate.c numlist.c packages.c parentchild.c \
	parpend.c pending.c proc.c procframe.c \
	procio.c prototype.c qlfdid.c refineinst.c rel_common.c relation.c \
	relation_io.c relation_util.c rootfind.c rounded.c safe.c \
	scanner.c select.c setinst_io.c setinstval.c setio.c \
	sets.c slist.c simlist.c statement.c statio.c switch.c \
	symtab.c syntax.c temp.c tmpnum.c type_desc.c \
	type_descio.c typedef.c typelint.c redirectFile.c \
    units.c universal.c \
	value_type.c visitinst.c visitlink.c vlist.c vlistio.c \
	watchpt.c watchptio.c when.c when_io.c when_util.c

LIB_OBJS = \
	anoncopy.o anonmerg.o anontype.o arrayinst.o ascCompiler.o \
	ascParse.o atomsize.o atomvalue.o bintoken.o bit.o braced.o \
	case.o check.o child.o childdef.o childio.o childinfo.o cmpfunc.o \
	commands.o copyinst.o createinst.o destroyinst.o \
	dimen.o dimen_io.o dump.o \
	evaluate.o exprio.o exprs.o exprsym.o extcall.o \
	extfunc.o extinst.o find.o forvars.o fractions.o \
	freestore.o func.o initialize.o instance.o instance_io.o \
	instantiate.o instmacro.o instquery.o interval.o \
	library.o linkinst.o logrel_io.o logrel_util.o \
	logrelation.o mathinst.o mergeinst.o module.o name.o \
	nameio.o notate.o numlist.o packages.o parentchild.o \
	parpend.o pending.o proc.o procframe.o \
	procio.o prototype.o qlfdid.o refineinst.o rel_common.o relation.o \
	relation_io.o relation_util.o rootfind.o rounded.o safe.o \
	scanner.o select.o setinst_io.o setinstval.o setio.o \
	sets.o slist.o simlist.o statement.o statio.o switch.o \
	symtab.o syntax.o temp.o tmpnum.o type_desc.o \
	type_descio.o typedef.o typelint.o redirectFile.o \
    units.o universal.o \
	value_type.o visitinst.o visitlink.o vlist.o vlistio.o \
	watchpt.o watchptio.o when.o when_io.o when_util.o

#  The global makefile macros (ConfigAscend) and global rules (Makefile.Rules)
#  
include $(builddir)/ConfigAscend
include $(builddir)/Makefile.Rules



#  File specific rules

#  The parser needs some massaging to change the prefix from `yy' to `zz_'

ascParse.o: $(srcdir)/ascParse.y

ascParse.c ascParse.h: $(srcdir)/ascParse.y
	$(YACC) -d $(srcdir)/ascParse.y
	$(RM) ascParse.h ascParse.c
	$(SED) -e "/#ifndef YYSTYPE/,/#endif/d" \
		-e "s/yy/zz_/g" -e "s/YY/ZZ_/g" < y.tab.c > ascParse.c
	$(SED) -e "s/yy/zz_/g" -e "s/YY/ZZ_/g" < y.tab.h > ascParse.h
	$(RM) y.tab.c y.tab.h


#  rounded needs a special define

rounded.o: $(srcdir)/rounded.h $(srcdir)/rounded.c $(srcdir)/compiler.h
	$(CC) -DSLOPPY $(CC_SWITCHES) -c $(srcdir)/rounded.c


#  The C file for the scanner (scanner.c) can either be generated by flex,
#  or it can come from a pregenerated C file.  The configure script will
#  set the $(MAKE) line under the ``scanner'' target to make either
#      scanner.c.from.flex   ---to generate the scanner using flex
#      scanner.c.from.c      ---to use the pregenerated C file
#  depending on the value of $(LEX).

scanner.o: $(srcdir)/scanner.l $(srcdir)/scanner.c.no.flex ./ascParse.h
	$(MAKE) @scanner_src@
	$(CC) $(CC_SWITCHES) -DYY_USE_CONST -c scanner.c

scanner.c.from.flex: $(srcdir)/scanner.l ./ascParse.h
	$(LEX) -Pzz_ -t $(srcdir)/scanner.l > scanner.c

scanner.c.from.c: $(srcdir)/scanner.c.no.flex
	$(CP) $(srcdir)/scanner.c.no.flex scanner.c

scanner.c: $(srcdir)/scanner.l $(srcdir)/scanner.c.no.flex ./ascParse.h
	$(MAKE) @scanner_src@


#  This ensures that packages was built with -DNO_PACKAGES 
#  when building the stand-alone compiler

.no-packages: packages.o
	$(RM) $?
	$(MAKE) $? HAVE_PACKAGES=-DNO_PACKAGES
	$(ECHO) 'Made packages.o with -DNO_PACKAGES' > $@

packages.o: $(srcdir)/packages.c
	$(CC) $(HAVE_PACKAGES) $(CC_SWITCHES) -c $(srcdir)/packages.c


###==> standalone compiler <==##############################
#  uncomment the following lines if you want to build a standalone
#  compiler with NO_PACKAGES selected in ConfigAscend.
#HAVE_PACKAGES = -DNO_PACKAGES
#PACK_LIBS = 


#  Here is a target to build a stand alone version of the ASCEND
#  compiler.  It makes sure packages was built with -NO_PACKAGES,
#  and then builds ascend.
#
stand-alone: .no-packages
	$(MAKE) ascend PACK_LIBS=""


#  profiling stuff -- DEC alpha only
#
time:
	$(PIXIE) ascend
	cd $(PIXIEDIR); $(builddir)/ascend.pixie ./system
	$(RM) /tmp/time.ascend
	prof $(PIXIE_OPTS) ascend ascend.Addrs \
	$(PIXIEDIR)/ascend.Counts > /tmp/time.ascend



#  Files, in addition to the default, to remove when we `make clean'

clean::
	-$(RM) ascParse.h ascParse.c y.ascParse.c y.ascParse.h yacc.* \
		scanner.c fascend .no-packages



# DO NOT DELETE THIS LINE -- g++dep uses it.
# DO NOT PUT ANYTHING AFTER THIS LINE, IT WILL GO AWAY.


# IF YOU PUT ANYTHING HERE IT WILL GO AWAY
#
