#include "ammonia.h"

/* Property data for Nitrogen

From Span, Lemmon, Jacobsen & Wagner
A Reference Quality Equation of State for Nitrogen
Int J Thermophysics, Vol 18, No 4, 1998.

This is the nitrogren property correlation recommended
by NIST in its program REFPROP 7.0. */

const IdealData ideal_data_nitrogen = {
	-12.76953 /* constant */
	,-0.007841630 /* linear */
	, 3 /* power terms */
	, (const IdealPowTerm[]){
		{1.934819,     -1.}
		,{-1.247742e-5, -2.}
		,{6.678326e-8,  -3.}
	}
	, 1
	, (const IdealExpTerm[]){
		{1.012941, 26.65788}
	}
};

const HelmholtzData helmholtz_data_nitrogen = {
	/* R */ 8.31451 / 28.01348e-3 /* J/molK * kg/mol = J/kg/K */
	, /* M */ 28.01348 /* kg/kmol */
	, /* rho_star */ 11.1839 * 28.01348 /* mol/L * kg/kmol = kg/kL = kg/mÂ³ = rho_c for this model*/
	, /* T_star */ 126.192 /* K = T_c for this model */
	, &ideal_data_nitrogen
	, 21 /* np */
	, (const HelmholtzPowTerm[]){
		/* a_i, t_i, d_i, l_i */
		{ 0.924803575275,      0.25,    1,  0}
		,{-0.492448489428,     0.875,   1,  0}
		,{ 0.661883336938,     0.5,     2,  0}
		,{-0.192902649201E1,   0.875,   2,  0}
		,{-0.622469309629E-1,  0.375,   3,  0}
		,{ 0.349943957581,     0.75,    3,  0}
		,{ 0.564857472498,     0.5,     1,  1}
		,{-0.161720005987E1,   0.75,    1,  1}
		,{-0.481395031883,     2.,      1,  1}
		,{ 0.421150636384,     1.25,    3,  1}
		,{-0.161962230825E-1,  3.5,     3,  1}
		,{ 0.172100994165,     1.,      4,  1}
		,{ 0.735448924933E-2,  0.5,     6,  1}
		,{ 0.168077305479E-1,  3.,      6,  1}
		,{-0.107626664179E-2,  0.,      7,  1}
		,{-0.137318088513E-1,  2.75,    7,  1}
		,{ 0.635466899859E-3,  0.75,    8,  1}
		,{ 0.304432279419E-2,  2.5,     8,  1}
		,{-0.435762336045E-1,  4.,      1,  2}
		,{-0.723174889316E-1,  6. ,     2,  2}
		,{ 0.389644315272E-1,  6.,      3,  2}
		,{-0.212201363910E-1,  3.,      4,  2}
		,{ 0.408822981509E-2,  3.,      5,  2}
		,{-0.551990017984E-4,  6.,      8,  2}
		,{-0.462016716479E-1, 16.,      4,  3}
		,{-0.300311716011E-2, 11.,      5,  3}
		,{ 0.368825891208E-1, 15.,      5,  3}
		,{-0.255856846220E-2, 12.,      8,  3}
		,{ 0.896915264558E-2, 12.,      3,  4}
		,{-0.441513370350E-2,  7.,      5,  4}
		,{ 0.133722924858E-2,  4.,      6,  4}
		,{ 0.264832491957E-3, 16.,      9,  4}
		/* more terms here still to come */
	}
	, 4 /* ne */
	, (const HelmholtzExpTerm[]){
		{0.196688194015e2, 0., 1, 20, 325, 1.16}
		, {-0.209115600730e2, 1., 1, 20, 325, 1.16}
		, {0.167788306989e-1, 2., 3, 15, 300, 1.13}
		, {0.262767566274e4, 3., 2, 25, 275, 1.25}
	}
};


/*
	Test suite. These tests attempt to validate the current code using 
	a few sample figures output by REFPROP 7.0.

	To run the test, compile and run as follows:

	gcc helmholtz.c nitrogen.c -DTEST -o nitrogen -lm && ./nitrogen

	These tests all currently pass with a maximum error of 2%. The error
	seems to arise in the enthalpy data for low temperatures. Haven't been
	able to determine where the problem comes from.
*/
#ifdef TEST

#include <assert.h>
#include <stdlib.h>
#include <stdio.h>
#include <math.h>

/* a simple macro to actually do the testing */
#define ASSERT_TOL(FN,PARAM1,PARAM2,PARAM3,VAL,TOL) {\
		double cval; cval = FN(PARAM1,PARAM2,PARAM3);\
		double err; err = cval - (double)(VAL);\
		double relerrpc = (cval-(VAL))/(VAL)*100;\
		if(fabs(relerrpc)>maxerr)maxerr=fabs(relerrpc);\
		if(fabs(err)>TOL){\
			fprintf(stderr,"ERROR in line %d: value of '%s(%f,%f,%s)' = %f, should be %f, error is %f (%.2f%%)!\n"\
				, __LINE__, #FN,PARAM1,PARAM2,#PARAM3, cval, VAL,cval-(VAL),relerrpc);\
			exit(1);\
		}else{\
			fprintf(stderr,"    OK, %s(%f,%f,%s) = %8.2e with %.2f%% err.\n",#FN,PARAM1,PARAM2,#PARAM3,VAL,relerrpc);\
			/*fprintf(stderr,"        (err = %8.2e, tol = %8.2e, calc = %8.2e)\n",fabs(err),TOL,cval);*/\
		}\
	}

typedef struct{double T,p,rho,h,s;} TestData;


/*
	A small set of data points calculated using REFPROP 7.0, for validation
*/
const TestData td[] = {
/* {T / K    , p / MPa    , rho / kg/m3, h / kJ/kg, s / kJ/kgK} */
	{-200.00000, 0.10000000, 824.94146, -130.56454, 2.7206049}
	, {-195.90650, 0.10000000, 806.59036, -122.24684, 2.8312405}
	, {-195.90650, 0.10000000, 4.5564811, 77.072848, 5.4116477}
	, {-150.00000, 0.10000000, 2.7651079, 126.49637, 5.9149401}
	, {-100.00000, 0.10000000, 1.9528859, 178.96289, 6.2726011}
	, {-50.000000, 0.10000000, 1.5119231, 231.14631, 6.5373809}
	, {0.00000000, 0.10000000, 1.2340278, 283.23654, 6.7480133}
	, {50.000000, 0.10000000, 1.0426377, 335.30559, 6.9230643}
	, {100.00000, 0.10000000, 0.90273132, 387.42000, 7.0730090}
	, {150.00000, 0.10000000, 0.79597134, 439.66508, 7.2043968}
	, {200.00000, 0.10000000, 0.71181434, 492.14150, 7.3216082}
	, {250.00000, 0.10000000, 0.64376369, 544.95214, 7.4277045}
	, {300.00000, 0.10000000, 0.58759653, 598.18966, 7.5248876}
	, {350.00000, 0.10000000, 0.54044842, 651.92860, 7.6147756}
	, {400.00000, 0.10000000, 0.50030750, 706.22257, 7.6985791}
	, {450.00000, 0.10000000, 0.46571913, 761.10483, 7.7772186}
	, {500.00000, 0.10000000, 0.43560536, 816.59095, 7.8514061}
	, {550.00000, 0.10000000, 0.40915040, 872.68219, 7.9217018}
	, {600.00000, 0.10000000, 0.38572547, 929.36893, 7.9885535}
	, {650.00000, 0.10000000, 0.36483807, 986.63370, 8.0523256}
	, {700.00000, 0.10000000, 0.34609700, 1044.4538, 8.1133192}
	, {750.00000, 0.10000000, 0.32918753, 1102.8031, 8.1717867}
	, {800.00000, 0.10000000, 0.31385363, 1161.6539, 8.2279428}
	, {850.00000, 0.10000000, 0.29988486, 1220.9778, 8.2819723}
	, {900.00000, 0.10000000, 0.28710667, 1280.7465, 8.3340357}
	, {950.00000, 0.10000000, 0.27537304, 1340.9326, 8.3842743}
	, {1000.0000, 0.10000000, 0.26456092, 1401.5096, 8.4328132}
	, {-200.00000, 1.0000000, 826.97227, -129.89700, 2.7148345}
	, {-169.40309, 1.0000000, 665.82825, -64.326777, 3.4600526}
	, {-169.40309, 1.0000000, 41.331104, 87.734007, 4.9257424}
	, {-150.00000, 1.0000000, 30.899666, 114.98204, 5.1673819}
	, {-100.00000, 1.0000000, 20.189927, 173.16514, 5.5653573}
	, {-50.000000, 1.0000000, 15.303926, 227.54808, 5.8414656}
	, {0.00000000, 1.0000000, 12.387522, 280.82813, 6.0569512}
	, {50.000000, 1.0000000, 10.426157, 333.64490, 6.2345305}
	, {100.00000, 1.0000000, 9.0097433, 386.27217, 6.3859570}
	, {150.00000, 1.0000000, 7.9362666, 438.89007, 6.5182852}
	, {200.00000, 1.0000000, 7.0935035, 491.64902, 6.6361293}
	, {250.00000, 1.0000000, 6.4137509, 544.68060, 6.7426703}
	, {300.00000, 1.0000000, 5.8536009, 598.09515, 6.8401771}
	, {350.00000, 1.0000000, 5.3838822, 651.97879, 6.9303076}
	, {400.00000, 1.0000000, 4.9842388, 706.39293, 7.0142967}
	, {450.00000, 1.0000000, 4.6400213, 761.37636, 7.0930813}
	, {500.00000, 1.0000000, 4.3404109, 816.94862, 7.1673842}
	, {550.00000, 1.0000000, 4.0772408, 873.11393, 7.2377727}
	, {600.00000, 1.0000000, 3.8442281, 929.86491, 7.3047002}
	, {650.00000, 1.0000000, 3.6364590, 987.18580, 7.3685349}
	, {700.00000, 1.0000000, 3.4500344, 1045.0552, 7.4295806}
	, {750.00000, 1.0000000, 3.2818204, 1103.4482, 7.4880919}
	, {800.00000, 1.0000000, 3.1292688, 1162.3378, 7.5442851}
	, {850.00000, 1.0000000, 2.9902865, 1221.6964, 7.5983461}
	, {900.00000, 1.0000000, 2.8631379, 1281.4962, 7.6504366}
	, {950.00000, 1.0000000, 2.7463717, 1341.7103, 7.7006986}
	, {1000.0000, 1.0000000, 2.6387646, 1402.3126, 7.7492578}
	, {-200.00000, 10.000000, 845.26732, -122.98508, 2.6622174}
	, {-150.00000, 10.000000, 614.63170, -20.755043, 3.7210595}
	, {-100.00000, 10.000000, 274.08684, 108.33718, 4.5999308}
	, {-50.000000, 10.000000, 165.69732, 193.43373, 5.0356176}
	, {0.00000000, 10.000000, 125.24775, 259.27189, 5.3024487}
	, {50.000000, 10.000000, 102.49734, 319.26216, 5.5043023}
	, {100.00000, 10.000000, 87.427859, 376.62733, 5.6694209}
	, {150.00000, 10.000000, 76.534477, 432.63584, 5.8103035}
	, {200.00000, 10.000000, 68.216292, 487.94924, 5.9338674}
	, {250.00000, 10.000000, 61.619660, 542.97600, 6.0444247}
	, {300.00000, 10.000000, 56.240667, 597.99135, 6.1448586}
	, {350.00000, 10.000000, 51.759585, 653.18645, 6.2371858}
	, {400.00000, 10.000000, 47.962302, 708.69313, 6.3228633}
	, {450.00000, 10.000000, 44.699287, 764.59931, 6.4029715}
	, {500.00000, 10.000000, 41.862548, 820.95992, 6.4783293}
	, {550.00000, 10.000000, 39.371915, 877.80536, 6.5495709}
	, {600.00000, 10.000000, 37.166488, 935.14803, 6.6171967}
	, {650.00000, 10.000000, 35.199092, 992.98747, 6.6816092}
	, {700.00000, 10.000000, 33.432569, 1051.3142, 6.7431376}
	, {750.00000, 10.000000, 31.837217, 1110.1129, 6.8020556}
	, {800.00000, 10.000000, 30.388987, 1169.3641, 6.8585940}
	, {850.00000, 10.000000, 29.068188, 1229.0464, 6.9129500}
	, {900.00000, 10.000000, 27.858530, 1289.1373, 6.9652942}
	, {950.00000, 10.000000, 26.746414, 1349.6141, 7.0157755}
	, {1000.0000, 10.000000, 25.720391, 1410.4542, 7.0645253}
	, {-150.00000, 100.00000, 842.03632, 39.237402, 3.2425037}
	, {-100.00000, 100.00000, 748.08407, 118.90189, 3.7864991}
	, {-50.000000, 100.00000, 668.62180, 193.68381, 4.1663797}
	, {0.00000000, 100.00000, 602.00192, 264.67164, 4.4536512}
	, {50.000000, 100.00000, 546.37705, 332.63655, 4.6822703}
	, {100.00000, 100.00000, 499.86285, 398.18975, 4.8709587}
	, {150.00000, 100.00000, 460.71962, 461.86446, 5.0311389}
	, {200.00000, 100.00000, 427.47644, 524.12999, 5.1702472}
	, {250.00000, 100.00000, 398.95507, 585.38730, 5.2933342}
	, {300.00000, 100.00000, 374.23539, 645.96722, 5.4039354}
	, {350.00000, 100.00000, 352.60470, 706.13381, 5.5045853}
	, {400.00000, 100.00000, 333.51020, 766.09157, 5.5971384}
	, {450.00000, 100.00000, 316.52039, 825.99447, 5.6829774}
	, {500.00000, 100.00000, 301.29531, 885.95525, 5.7631519}
	, {550.00000, 100.00000, 287.56440, 946.05406, 5.8384731}
	, {600.00000, 100.00000, 275.11003, 1006.3459, 5.9095787}
	, {650.00000, 100.00000, 263.75533, 1066.8665, 5.9769785}
	, {700.00000, 100.00000, 253.35515, 1127.6376, 6.0410866}
	, {750.00000, 100.00000, 243.78927, 1188.6704, 6.1022442}
	, {800.00000, 100.00000, 234.95724, 1249.9686, 6.1607365}
	, {850.00000, 100.00000, 226.77444, 1311.5305, 6.2168049}
	, {900.00000, 100.00000, 219.16910, 1373.3507, 6.2706560}
	, {950.00000, 100.00000, 212.07988, 1435.4217, 6.3224685}
	, {1000.0000, 100.00000, 205.45406, 1497.7339, 6.3723982}
};


int main(void){

	double rho, T, p, h, u;
	const HelmholtzData *d;

	d = &helmholtz_data_nitrogen;
	double maxerr = 0;

	unsigned i;
	const unsigned n = sizeof(td)/sizeof(TestData);

	fprintf(stderr,"Running through %d test points...\n",n);

	fprintf(stderr,"PRESSURE TESTS\n");
	for(i=0; i<n;++i){
	 	ASSERT_TOL(helmholtz_p, td[i].T+273.15, td[i].rho, d, td[i].p*1e6, 1E3);
	}

	/* offset required to attain agreement with REFPROP */
	double Y = -471.596704;

	fprintf(stderr,"ENTROPY TESTS\n");
	for(i=0; i<n;++i){
	 	ASSERT_TOL(helmholtz_s, td[i].T+273.15, td[i].rho, d, td[i].s*1e3 + Y, 1E3);
	}

	/* this offset is required to attain agreement with values from REFPROP */
	double Z = -1635.7e3 + 1492.411e3;

	fprintf(stderr,"ENTHALPY TESTS\n");
	for(i=0; i<n;++i){
	 	ASSERT_TOL(helmholtz_h, td[i].T+273.15, td[i].rho, d, td[i].h*1e3 + Z, 1E3);
	}

	fprintf(stderr,"Tests completed OK (maximum error = %0.2f%%)\n",maxerr);
	exit(0);
}
#endif

